#!/bin/sh
# Sanity checks for agent-workspace

set -e

IMAGE_NAME="agent-workspace"
VOLUME_MOUNTS="agent-home:/home/dev agent-cache:/home/dev/.cache"

if [ -n "$XDG_CONFIG_HOME" ]; then
    CONFIG_FILE="$XDG_CONFIG_HOME/agent-workspace/agent-w.conf"
else
    CONFIG_FILE="$HOME/.agent-w.conf"
fi

[ -r "$CONFIG_FILE" ] || { printf 'Error: config not found: %s\n' "$CONFIG_FILE" >&2; exit 1; }

# shellcheck source=/dev/null
. "$CONFIG_FILE"

[ -n "$AGENT_WORKSPACE_HOME" ] || { printf 'Error: AGENT_WORKSPACE_HOME not set in config\n' >&2; exit 1; }

if [ -t 1 ]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[0;33m'
    NC='\033[0m'
else
    GREEN='' RED='' YELLOW='' NC=''
fi

PASS=0 WARN=0 FAIL=0

pass() {
    printf "%b[OK]%b   %s\n" "$GREEN" "$NC" "$1"
    PASS=$((PASS + 1))
}

warn() {
    printf "%b[WARN]%b %s\n" "$YELLOW" "$NC" "$1"
    WARN=$((WARN + 1))
}

fail() {
    printf "%b[FAIL]%b %s\n" "$RED" "$NC" "$1"
    FAIL=$((FAIL + 1))
}

check_docker() {
    if command -v docker >/dev/null 2>&1; then
        pass "Docker installed"
    else
        fail "Docker not installed"
    fi

    if docker info >/dev/null 2>&1; then
        pass "Docker daemon running"
    else
        fail "Docker daemon not running"
    fi
}

check_image() {
    if docker image inspect "$IMAGE_NAME" >/dev/null 2>&1; then
        pass "Image '$IMAGE_NAME' exists"
    else
        warn "Image '$IMAGE_NAME' not found (run: agent-workspace build)"
    fi
}

check_volume() {
    vol="$1"
    if docker volume inspect "$vol" >/dev/null 2>&1; then
        pass "Volume '$vol' exists"
    else
        warn "Volume '$vol' not found (created on first run)"
    fi
}

check_os() {
    os="$(uname -s)"
    case "$os" in
        Linux)  pass "OS: Linux" ;;
        Darwin) pass "OS: macOS" ;;
        *)      warn "OS: $os (untested)" ;;
    esac
}

print_summary() {
    printf "\nSummary: %b%d passed%b" "$GREEN" "$PASS" "$NC"
    [ "$WARN" -gt 0 ] && printf ", %b%d warnings%b" "$YELLOW" "$WARN" "$NC"
    [ "$FAIL" -gt 0 ] && printf ", %b%d failed%b" "$RED" "$FAIL" "$NC"
    printf "\n"
}

main() {
    printf "agent-workspace doctor\n\n"

    check_docker
    check_os
    check_image

    for mount in $VOLUME_MOUNTS; do
        case "$mount" in
            *:*)
                vol=${mount%%:*}
                [ -n "$vol" ] && check_volume "$vol"
                ;;
        esac
    done

    pass "No dangerous mounts (docker.sock, .ssh, .gitconfig)"

    print_summary
    [ "$FAIL" -gt 0 ] && exit 1
}

main "$@"
